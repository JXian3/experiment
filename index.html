<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Consumption Experiment</title>
  <script src="./jspsych/jspsych.js"></script>
  <script src="./jspsych/plugin-html-slider-response.js"></script>
  <script src="./jspsych/plugin-html-button-response.js"></script>
  <script src="./jspsych/plugin-survey-html-form.js"></script>
  <script src="./jspsych/plugin-survey-text.js"></script>
  <script src="./jspsych/plugin-instructions.js"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <script src="./jspsych/plugin-preload.js"></script>
  <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="style.css">
  <style>
    .jspsych-html-slider-response {
      margin-top: -100px !important;
    }
  </style>
</head>
<body>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const jsPsych = initJsPsych({
        override_safe_mode: true,
        show_progress_bar: true,
        on_finish: function() {
          window.location = "https://connect.cloudresearch.com/participant/project/0A99740563/complete";
          //window.location = "https://connect.cloudresearch.com/participant/project/2CED66B84E/complete";
        }
      });

/* ================= DATA ================= */
const subject_id = jsPsych.randomization.randomID(10);
//const filename = `${subject_id}.csv`;
const mturk_pilot_mode = false
if(mturk_pilot_mode) { 
    var study_id = 'test';
    var session_id = 'test';
    participant_id = 'test_' + String(jsPsych.randomization.randomID(10)) //overwrite the participant id
} else {
    participant_id = jsPsych.data.getURLVariable('participantId'); 
    var assignment_id = jsPsych.data.getURLVariable('assignmentId');
    var project_id = jsPsych.data.getURLVariable('projectId');
}

jsPsych.data.addProperties({
  mturk_participant_id: participant_id,
  mturk_assignment_id: assignment_id,
  mturk_project_id: project_id
});

const filename = `${participant_id}.csv`;

/* ================= STIMULI ================= */
const categories = {

food:{stimuli:[
    {label:"Cookie ğŸª",need:"Adam feels hungry and wants to eat <b>4</b> cookies.", base_action:"cookie",unit:"cookies",verb:"eats", past: "ate", emoji:"ğŸª", null:"Suppose that Adam did not get to eat any cookies. "},
    {label:"Ice cream ğŸ¦",need:"Nia feels hungry and wants to eat <b>4</b> scoops of ice cream.",base_action:"scoop of ice cream",unit:"scoops of ice cream",verb:"eats", past: "ate", emoji:"ğŸ¦", null:"Suppose that Nia did not get to eat any ice creams."},
    {label:"Soda ğŸ¥¤",need:"Zuri feels thirsty and wants to drink <b>4</b> cups of water.",base_action:"cup of water",unit:"cups of water",verb:"drinks", past: "drank", emoji:"ğŸ¥¤", null:"Suppose that Zuri did not get to drink any water. "},
    {label:"Candy ğŸ¬",need:"Chen feels hungry and wants to eat <b>4</b> candies.",base_action:"candy",unit:"candies",verb:"eats", past: "ate", emoji:"ğŸ¬", null:"Suppose that Chen did not get to eat any candies."},
    {label:"Healthy fruits ğŸŠ",need:"Eric feels hungry and wants to eat <b>4</b> oranges.",base_action:"orange",unit:"oranges",verb:"eats", past: "ate",emoji:"ğŸŠ", null:"Suppose that Eric did not get to eat any oranges."},
    ]},

  sensory:{stimuli:[
    {label:"Light ğŸ’¡",need:"Ethan thinks it's too dark in his room, and he wants to make the light brighter by turning it up <b>4</b> times.",base_action:"time",unit:"times",verb:"turns up", past: "turned the light up by",emoji:"ğŸ’¡", null:"Suppose that Ethan did not get to turn the light up."},
    {label:"Light ğŸ’¡",need:"Ethan thinks it's too bright in his room, and he wants to make the light dimmer by turning it down <b>4</b> times.",base_action:"time",unit:"times",verb:"turns down", past: "turned the light down by",emoji:"ğŸ’¡", null:"Suppose that Ethan did not get to turn the light down."},
    {label:"Sound ğŸ”Š",need:"The music is too soft at Han's party and he wants to turn up the volume by <b>4</b> levels.",base_action:"level",unit:"levels",verb:"turns up the volume", past: "turned up the volume by", emoji:"ğŸ”Š", null:"Suppose that Han did not get to turn the volume up."},
    {label:"Sound ğŸ”Š",need:"The music is too loud at Han's party and he wants to turn down the volume by <b>4</b> levels.",base_action:"level",unit:"levels",verb:"turns down the sound", past: "turned down the sound by", emoji:"ğŸ”Š", null:"Suppose that Han did not get to turn the volume down."},
    {label:"Temperature ğŸŒ¡ï¸",need:"Jasmine's apartment is too cold, and she wants to turn up the thermostat by <b>4</b> clicks.",base_action:"click",unit:"clicks",verb:"turns up the thermostat", past: "turned up the thermostat by", emoji:"ğŸŒ¡ï¸", null:"Suppose that Jasmine did not get to turn the thermostat up."},
    {label:"Temperature ğŸŒ¡ï¸",need:"Jasmine's apartment is too hot, and she wants to turn down the thermostat by <b>4</b> clicks.",base_action:"click",unit:"clicks",verb:"turns down the thermostat", past: "turned down the thermostat by", emoji:"ğŸŒ¡ï¸", null:"Suppose that Jasmine did not get to turn the thermostat down."},
    {label:"Scent ğŸ’¨",need:"Lucy is preparing for a date and she's worried that she doesn't smell good enough. <br> She wants to put on <b>4</b> sprays of her new perfume.",base_action:"spray of perfume",unit:"sprays of perfume",verb:"puts on", past: "put on", emoji:"ğŸ’¨", null:"Suppose that Lucy did not get to put on any perfume."},
    {label:"Taste ğŸ§‚",need:"Amir is eating dinner and thinks his food tastes bland. He wants to add <b>4</b> dashes of spices to it",base_action:"dash of spice, and tasted the food", past: "added", unit:"dashes of spices, and tasted the food",verb:"adds",emoji:"ğŸ§‚",  null:"Suppose that Amir did not get to add any spices."}]},
 
  entertainment:{stimuli:[
    {label:"Gaming ğŸ®",need:"Hiro is bored over the weekend and wants to play video games for <b>4</b> hours.",base_action:"hour",unit:"hours",verb:"plays games for", past: "played games for", emoji:"ğŸ®", null:"Suppose that Hiro did not get to play video games."},
    {label:"Watching TV ğŸ“º",need:"Malik is bored over the weekend and wants to watch TV shows for <b>4</b> hours.",base_action:"hour",unit:"hours",verb:"watches TV for", past: "watched TV shows for", emoji:"ğŸ“º", null:"Suppose that Malik did not get to watch TV."},
    {label:"Scrolling Social Media ğŸ“±",need:"Emma is bored over the weekend and wants to scroll her Instagram feed for <b>4</b> hours.",base_action:"hour",unit:"hours", past: "scrolled for", verb:"scrolls Instagram for",emoji:"ğŸ“±", null:"Suppose that Emma did not get to scroll her Instagram feed."},
    {label:"Reading ğŸ“–",need:"Maya is bored over the weekend and wants to read a book for <b>4</b> hours.",base_action:"hour",unit:"hours",verb:"reads books for", past: "read for", emoji:"ğŸ“–", null:"Suppose that Maya did not get to read books."},
    {label:"Drawing ğŸ¨",need:"Jaden is bored over the weekend and wants to work on a new painting for <b>4</b> hours.",base_action:"hour",unit:"hours",verb:"draws for", past: "drew for", emoji:"ğŸ¨", null:"Suppose that Jaden did not get to work on the painting."},]},
  
  social: {
  stimuli: [
    { label: "Inviting friends ğŸ‘©", need: "Jack feels lonely, so he throws a party and sends invitations to his friends. <br> His apartment can comfortably host <b>4</b> people.", base_action: "friend showed up at Jack's apartment", verb: "has", past: "had", unit: "friends showed up at Jack's apartment", emoji: "ğŸ‘©", null:"Suppose that no one showed up at Jack's party."},
    { label: "Time with acquaintance ğŸ§‘â€ğŸ¤â€ğŸ§‘", need: "Mei feels lonely and wants to hang out with acquaintances. <br> She met a few people through a meet-and-greet and would like to spend <b>4</b> hours with them again.", base_action: "hour with acquintances", verb: "spends", past: "spent", unit: "hours with acquaintances", emoji: "ğŸ§‘â€ğŸ¤â€ğŸ§‘", null:"Suppose that Mei did not get to spend any time with acquintances."},
    { label: "Meeting new people ğŸ§‘ğŸ¼", need: "Akira is new in town and wants to expand her social circle. <br> She is at a meet-and-greet with the goal of meeting <b>4</b> new people, whom she wants to introduce herself to and talk with. ", base_action: "new person", unit: "new people", verb: "meets",  past: "met", emoji: "ğŸ§‘ğŸ¼", null:"Suppose that Akira did not get to meet and talk with any new people."},
    { label: "Time alone ğŸ‘¤", need: "Olivia had a long, tiring week and wants to spend <b>4</b> hours of her Saturday alone.", base_action: "hour alone", unit: "hours alone", verb: "spends", past: "spent", emoji: "ğŸ‘¤",  null:"Suppose that Olivia did not get to spend any time alone"},
    { label: "Facetiming ğŸ“", need: "Grace feels lonely and wants to FaceTime her friends for <b>4</b> hours.", base_action: "hour", unit: "hours", verb: "facetimes", past: "FaceTimed her friends for", emoji: "ğŸ“",  null:"Suppose that Grace did not get to FaceTime her friends."},]}
};

// Randomize the optimum (3 or 4) for every stimulus
Object.keys(categories).forEach(cat => {
  categories[cat].stimuli.forEach(stim => {
    const opt = jsPsych.randomization.sampleWithoutReplacement([3, 4], 1)[0];
    stim.need = stim.need.replace(/<b>4<\/b>/g, `<b>${opt}</b>`);
    stim.optimum = opt;
  });
});

function possessiveFor(name){
  const female = new Set(['Akira','Nia','Mei','Zuri','Olivia','Akira','Lucy','Jasmine','Maya','Grace']);
  const male   = new Set(['Hiro','Adam','Eric','Han','Ethan','Amir','Chen','Jack','Jaden','Malik']);
  if (female.has(name)) return 'her';
  if (male.has(name)) return 'his';
  return 'their';
}

function dynamicFollowupPrompt() {
  const last = jsPsych.data.get().last(1).values()[0] || {};
  const last_response = last.response;
  const poss = last.possessive || possessiveFor(last.childName);

  if (last_response >= 75) {
    return `Why did you think ${poss} will feel very good?`;
  } else if (last_response >= 55) {
    return `Why did you think ${poss} will feel good?`;
  } else if (last_response >= 45) {
    return `Why did you think ${poss} will feel bad?`;
  } else if (last_response >= 25) {
    return `Why did you think ${poss} will feel very bad?`;
  } else {
    return `Why did you think ${poss} will feel neutral?`;
  }
}

function buildVisual(nEmoji, emoji, cat, childImg, childName, isBonus = false){
  const gridSrc = 'img/grid4.png';
  return `
    <div class="visual-wrapper ${cat}">
      <div class="emoji-bubble">${emoji}</div>
      <img src="img/${childImg}.png" alt="${childName}" class="child-image">
      <img src="${gridSrc}" class="grid-image" alt="grid">
      <div class="emoji-track">
        ${Array.from({ length: nEmoji }).map(() => `<span>${emoji}</span>`).join('')}
      </div>
    </div>`;
}

// --- helper to map slider positions to tutorial images ---
function positionToImage(pos){
  const map = {
    0:  'muchworse.png',
    25: 'littleworse.png',
    50: 'nochange.png',
    75: 'littlebetter.png',
    100:'muchbetter.png'
  };
  return map[pos];
}

// --- helper to verbalâ€‘describe slider positions for feedback ---
function sliderPosDesc(value){
  if(value === 0)   return 'on the far left';
  if(value === 100) return 'on the far right';
  if(value === 50)  return 'in the middle';
  return value < 50 ? 'somewhat to the left' : 'somewhat to the right';
}

function sliderTrial({ visual, need, msg, cat, label, amt, n, poss, childName }) {
  return {
    type: jsPsychHtmlSliderResponse,
    stimulus: visual + `<p>${msg}</p>` +
              `<img src=\"img/feelingScale2.png\" class=\"feeling-scale\" alt=\"scale\">`,
    labels: ["Very Bad","Bad","Neutral","Good","Very Good"],
    min: 0, max: 100, slider_start: 50, require_movement: true,
    prompt: `<p style="text-align:center; margin-top:5px; margin-bottom:15px;">Drag the slider to indicate your answer.</p>`,
    data: { category: cat, stimulus_label: label, trial_number: n, amount: amt, possessive: poss, childName }
  };
}

function attentionCheck(direction) {
  const txt = direction === 'right'
    ? "Please drag the slider all the way to the right, and click continue."
    : "Please drag the slider all the way to the left, and click continue.";
  return {
    type: jsPsychHtmlSliderResponse,
    stimulus: `<p>${txt}</p>` +
              `<img src=\"img/feelingScale.png\" class=\"feeling-scale\" alt=\"scale\">`,
    labels: ["Much worse","A little worse","No change","A little better","Much better"],
    min: 0, max: 100, slider_start: 50, require_movement: true,
    prompt: `<p style="text-align:center; margin-top:20px;">Drag the slider to indicate your answer.</p>`,
    data: { attention_check: true, correct_direction: direction },
    on_finish: d => { d.correct = (direction === 'right' ? d.response === 100 : d.response === 0); }
  };
}

/* ================= START ================= */
var duration = '5 minutes';
    var amount = '$1.25';
var consent = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p><b>Consent Form</b></p> <div style="text-align:left; background-color:lightblue; padding:2vw; max-width:80vw; max-height:60vh; overflow-y:auto;">' +
        '<p style="text-align:left;"><b>Purpose:</b> The purpose of this study is to understand ' +
        'how people think about others\' feelings.</p>' +
        '<p style="text-align:left;"><b>Procedures:</b> In this study, you will read sentences, ' +
        'see pictures, and use sliders to answer simple questions ' +
        'about them. This study should take approximately ' + duration + '.</p>' +
        '</p><p style="text-align:left;"><b>Participation:</b> Participation in this study is ' +
        'voluntary. If you decide to join now, you can change your mind ' +
        'later. ' +
        '</p><p style="text-align:left;"><b>Payment:</b> You will be paid $15.00/hour ' +
        'for participating in this study. Given the estimated duration of ' +
        duration + ', your payment will amount to ' + amount + '.</p>' +
        '<p style="text-align:left;"><b>Risks and benefits:</b> There are no risks associated ' +
        'with participating in this study. There are no direct benefits ' +
        'associated with participating in this study. </p><p style="text-align:left;"><b>Use of ' +
        'data by study researchers:</b> The research team led by Shari ' +
        'Liu at JHU will have access to your answers. ' +
        '</p><p style="text-align:left;"><b>Publication of results:</b> The results of the research ' +
        'may be presented at scientific meetings or published in scientific ' +
        'journals. Your individual responses may be published. We will ' +
        'never publish your name, the date that you participated, and any other ' +
        'information that could be used to identify you. </p><p style="text-align:left;"><b>' +
        'Researcher contact information:</b> This study is run by Dr. ' +
        'Shari Liu at JHU. If you have any questions or concerns about ' +
        'this study, or in the very unlikely event of a research-related ' +
        'injury, please contact sliu199@jhu.edu. ' +
        '</p><p style="text-align:left;"><b>Research rights information:</b> If you have questions about ' +
        'your rights as a research participant or feel that you have not ' +
        'been treated fairly, please call the Homewood Institutional Review ' +
        'Board at Johns Hopkins University at (410) 516-6580. If you have ' +
        'any questions or issues completing the survey, please email Shari ' +
        'Liu at sliu199@jhu.edu. </p> </div>' +
        '<p> Do you consent to participate? </p>',
    choices: ['Yes', 'No'],
    data: {trial_id: 'consent'},
    on_finish: function(data) {
    if (data.response === 1) { 
    jsPsych.abortExperiment('You did not consent to participate. The study will now end. Thank you for your time.');  
    }
    }
};

/* ================= INTRO ================= */
const intro = {
  type: jsPsychHtmlButtonResponse,    
  stimulus: `
    <div class="intro-screen">
      <h2>Welcome to the study!</h2>
      <p>In the upcoming task, you will read short scenarios in which a character wants a specific amount or change.</p>
      <p>After you see what happens, You will use a slider to rate how the character feels in each scenario.</p>
      <p>The study will start with short tutorials on the sliders, followed by the tasks. </p>
      <p>Click â€œContinueâ€ to begin a short tutorial.</p>
    </div>`,
  choices: ['Continue']
};

/* ================= TUTORIAL ================= */
const demoScreens = [
  { kind: 'slider', html: `<p>People do a variety of activities, and their feelings can change after each activity.<br>Your job is to use the slider below to rate how a person's feeling would change after the activity.</p>`, pos: 50 },
  { kind: 'image',  html: `<p>If someone feels <b>much worse</b> than before, the slider should look like this.</p>`, pos: 0 },
  { kind: 'image',  html: `<p>If someone feels <b>a little worse</b> than before, the slider should look like this.</p>`, pos: 25 },
  { kind: 'image',  html: `<p>If someone's feeling <b>does not change</b>, the slider should look like this.</p>`, pos: 50 },
  { kind: 'image',  html: `<p>If someone feels <b>a little better</b> than before, the slider should look like this.</p>`, pos: 75 },
  { kind: 'image',  html: `<p>If someone feels <b>much better</b> than before, the slider should look like this.</p>`, pos: 100 },
];

const checkLevels = [
  { text: 'much worse',      value: 0  },
  { text: 'a little worse',  value: 25 },
  { text: 'no change',       value: 50 },
  { text: 'a little better', value: 75 },
  { text: 'much better',     value: 100 }
];

function buildTutorialSequence(){
  const seq = [];

  // 1) Demo screens
  demoScreens.forEach((item, idx) => {
    if (item.kind === 'slider') {
      seq.push({
        type: jsPsychHtmlSliderResponse,
        stimulus: item.html + `<img src="img/feelingScale.png" class="feeling-scale" alt="scale">`,
        labels: ["Much worse","A little worse","No change","A little better","Much better"],
        min: 0, max: 100, slider_start: item.pos, require_movement: false,
        data: { tutorial_page: idx + 1, tutorial_kind: 'demo-slider' }
      });
    } else {
      seq.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: item.html + `<img src="img/${positionToImage(item.pos)}" class="feeling-scale" alt="scale image">`,
        choices: ['Continue'],
        data: { tutorial_page: idx + 1, tutorial_kind: 'demo-image' }
      });
    }
  });

  // 2) Comprehension checks with auto feedback
  checkLevels.forEach((q, i) => {
    // question
    seq.push({
      type: jsPsychHtmlSliderResponse,
      stimulus: (i === 0
        ? `<p><b>Now let's check if you understand how the slider works!</b></p>`
        : ``) + `<p>If someone feels <b>${q.text}</b> than before, where should the slider go?</p>` +
        `<img src="img/feelingScale.png" class="feeling-scale" alt="scale">`,
      labels: ["Much worse","A little worse","No change","A little better","Much better"],
      min: 0, max: 100, slider_start: 50, require_movement: true,
      data: { tutorial_check: true, check_label: q.text, check_value: q.value },
      on_finish: function(data) {
        data.correct = Math.abs(data.response - q.value) <= 20;
      }
    });

    // conditional WRONG feedback
    seq.push({
      timeline: [{
        type: jsPsychHtmlSliderResponse,
        stimulus:
          `<p style="color:red;"><b>Wrong.</b></p>
           <p>If someone feels <b>${q.text}</b> than before, the slider should be <b>${sliderPosDesc(q.value)}</b>.</p>` +
          `<img src="img/feelingScale.png" class="feeling-scale" alt="scale">`,
        labels: ["Much worse","A little worse","No change","A little better","Much better"],
        min: 0, max: 100, slider_start: q.value, require_movement: false
      }],
      conditional_function: function() {
        const last = jsPsych.data.get().last(1).values()[0];
        return !last.correct;
      }
    });

    seq.push({
      timeline: [{
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p style="color:green; font-weight:bold;">âœ… Correct!</p>`,
        choices: ['Continue']
      }],
      conditional_function: function() {
        const last = jsPsych.data.get().last(1).values()[0];
        return last.correct;
      }
    });
  });

  return seq;
}

const tutorialSequence = buildTutorialSequence();

/* ================= TRANSITION ================= */
var transition_expt1 = {
  type: jsPsychHtmlButtonResponse,
  stimulus:
    `<div class="intro-screen">
      <p><b>Welcome to the study!</b></p>
      <p>In the upcoming task, you will read short scenarios in which a character wants a specific amount of items or a specific change.</p>
      <p>After you see what happens, You will use a slider to rate how the character feels in each scenario.</p>
      <p><br>When you're ready to begin, please click "Continue".</p>
    </div>`,
  choices: ['Continue']
};

/* ================= DEMOGRAPHICS ================= */
const feedback_demographics = {
  type: jsPsychSurveyHtmlForm,
  html:
    '<div style="max-width:700px; text-align:center;">' +
      '<div style="max-height:60vh; overflow-y:auto; margin:0 auto; padding-right:8px;"> <p>' +
        'What factors influenced how you decided to respond? Do you' +
        ' have any questions or comments regarding the experiment?' +
        '</p> <textarea name="feedback" cols="40" rows="6"' +
        ' "autofocus"></textarea> <p> Please provide the following' +
        ' information to complete the study. </p> <div style="text-' +
        'align:center;"> <div style="text-align:left; display:' +
        'inline-block; margin-right:20px; line-height:1.8em;"> <ol>' +
            '<li>Age:</li> <br>' +
            '<li>Gender:</li> <br><br>' +
            '<li>Race:</li> <br><br><br><br><br><br>' +
            '<li>Ethnicity:</li>' +
        '</ol> </div>' +
        '<div style="text-align:left; display: inline-block;' +
        ' line-height:1.8em;">' +
            // age text box
            '<input name="age" type="number"  min="18" max="100" /> <br> <br>' +
            // gender options
            '<input name="gender" type="radio" id="female" value=' +
                '"Female" /> <label for="female"> Female </label>' +
            '<input name="gender" type="radio" id="male" value=' +
                '"Male" /> <label for="male"> Male </label>' +
            '<input name="gender" type="radio" id="nonbinary" value=' +
                '"Non-binary" /> <label for="nonbinary"> Non-binary </label> <br>' +
            '<input name="gender" type="radio" id="other_gender" value=' +
                '"other_gender" /> <label for="other_gender"> Other: <input' +
                ' type="text" name="other_gender" /> </label> <br><br>' +
            // race options
            '<input name="race" type="radio" id="white" value=' +
                '"White" /> <label for="white"> White </label> <br>' +
            '<input name="race" type="radio" id="black" value=' +
                '"Black/African American" /> <label for="black">' +
                ' Black/African American </label> <br>' +
            '<input name="race" type="radio" id="am_ind" value=' +
                '"American Indian/Alaska Native" /> <label for="am_ind">' +
                ' American Indian/Alaska Native </label> <br>' +
            '<input name="race" type="radio" id="asian" value=' +
                '"Asian" /> <label for="asian"> Asian </label> <br>' +
            '<input name="race" type="radio" id="pac_isl" value=' +
                '"Native Hawaiian/Pacific Islander" /> <label for="pac_isl">' +
                ' Native Hawaiian/Pacific Islander </label> <br>' +
            '<input name="race" type="radio" id="other_race" value="other_race" />' +
                '<label for="other_race"> Other: <input type="text"' +
                'name="other_race" /> </label> <br><br>' +
            '<input name="ethnicity" type="radio" id="hisp" value=' +
                '"Hispanic" /> <label for="hisp"> Hispanic </label>' +
            '<input name="ethnicity" type="radio" id="nonhisp" value=' +
                '"Non-Hispanic" /> <label for="nonhisp"> Non-Hispanic' +
                ' </label>' +
        '</div> </div>' +
      '</div>' + 
      '</div>' + 
      '<p> Please press the finish button to complete the experiment. </p> </div>',
  button_label: 'Submit',
  data: { trial_id: 'demographics_survey' },
  on_finish: function(data) {
    const r = data.response;
    if (r.gender === "Other" && r.gender_other) r.gender = r.gender_other;
    if (r.race === "Other" && r.race_other) r.race = r.race_other;
    data.feedback = r.feedback;
    data.age = r.age;
    data.gender = r.gender;
    data.race = r.race;
    data.ethnicity = r.ethnicity;
  }
};

const save_data = {
                type: jsPsychPipe,
                action: "save",
                experiment_id: "KOYuJppiQBb9",
                filename: filename,
                data_string: ()=>jsPsych.data.get().csv()
              };

var urlvar = jsPsych.data.urlVariables();
jsPsych.data.addProperties({
  url: urlvar
});

/* ================= DEBRIEF ================= */
var debrief = {
        type: jsPsychInstructions,
        pages: [
            '<p style="font-size: 20px;"><strong>Debrief</strong></p>' +
            '<p><br>Thank you so much for helping us with this study!</p>' +
            '<br><p style = "max-width:800px;"> In this study, we asked you questions about how charactersâ€™ feelings would be at different stages of satisfaction. ' +
            'The goal is to test the hypothesis that people intuitively think that the additional satisfaction gained from each extra unit decreases over time, and may ultimately become negative. ' +
            '</p><br><p style = "max-width:800px;">Next up, we have a few final questions about yourself and your experience today.</p>'
        ],
        show_clickable_nav: true,
        button_label_next: 'Next'
        };

/* ================= TIMELINE ================= */
//const timeline = [preload, consent, intro, ...tutorialSequence, transition_expt1];
const timeline = [consent,transition_expt1];
const childMap = {
  'food::Cookie ğŸª':              { name: 'Adam', img: 'AdamBubble' },
  'food::Ice cream ğŸ¦':           { name: 'Nia', img: 'NiaBubble' },
  'food::Soda ğŸ¥¤':                { name: 'Zuri', img: 'ZuriBubble' },
  'food::Candy ğŸ¬':               { name: 'Chen', img: 'ChenBubble' },
  'food::Healthy fruits ğŸŠ':      { name: 'Eric', img: 'EricBubble' },
  'sensory::Light ğŸ’¡':            { name: 'Ethan', img: 'EthanBubble' },
  'sensory::Sound ğŸ”Š':       { name: 'Han', img: 'HanBubble' },
  'sensory::Temperature ğŸŒ¡ï¸': { name: 'Jasmine', img: 'JasmineBubble' },
  'sensory::Scent ğŸ’¨':            { name: 'Lucy', img: 'LucyBubble' },
  'sensory::Taste ğŸ§‚':            { name: 'Amir', img: 'AmirBubble' },
  'entertainment::Gaming ğŸ®':     { name: 'Hiro', img: 'HiroBubble' },
  'entertainment::Watching TV ğŸ“º':{ name: 'Malik', img: 'MalikBubble' },
  'entertainment::Scrolling Social Media ğŸ“±': { name: 'Emma', img: 'EmmaBubble' },
  'entertainment::Reading ğŸ“–':    { name: 'Maya', img: 'MayaBubble' },
  'entertainment::Drawing ğŸ¨':    { name: 'Jaden', img: 'JadenBubble' },
  'social::Inviting friends ğŸ‘©':  { name: 'Jack', img: 'JackBubble' },
  'social::Time with acquaintance ğŸ§‘â€ğŸ¤â€ğŸ§‘': { name: 'Mei', img: 'MeiBubble' },
  'social::Meeting new people ğŸ§‘ğŸ¼': { name: 'Akira', img: 'AkiraBubble' },
  'social::Time alone ğŸ‘¤':        { name: 'Olivia', img: 'OliviaBubble' },
  'social::Facetiming ğŸ“': { name: 'Grace', img: 'GraceBubble' },
};

// helpers for string-building logic
function labelStartsWith(s, head){
  return (s?.label || '').trim().startsWith(head);
}

function formatQty(amount, stim){
  if (amount === 1) return `<b>1</b> ${stim.base_action}`;
  return `<b>${amount}</b> ${stim.unit}`;
}

function buildMessage(name, stim, amount, isParty){
  if (amount === 0) {
    return `<br> <br> ${stim.null} How would ${name} feel?`;
  }
  if (isParty) {
    return `Suppose that ${formatQty(amount, stim)}. How would Jack feel?`;
  }
  return `Suppose that ${name} ${stim.past} ${formatQty(amount, stim)}. How would ${name} feel?`;
}

// Present all stimuli in a completely random order
const allStimuli = [];
Object.keys(categories).forEach(cat => {
  let list = categories[cat].stimuli;

  if (cat === 'sensory') {
    const items = categories[cat].stimuli || [];
    const group = head => items.filter(s => labelStartsWith(s, head));
    const isPairedHead = s => labelStartsWith(s, 'Light') || labelStartsWith(s, 'Sound') || labelStartsWith(s, 'Temperature');

    const others = items.filter(s => !isPairedHead(s));
    const pickOne = arr => (arr.length ? arr[jsPsych.randomization.randomInt(0, arr.length - 1)] : null);

    const chosen = [];
    const light = pickOne(group('Light')); if (light) chosen.push(light);
    const sound = pickOne(group('Sound')); if (sound) chosen.push(sound);
    const temp  = pickOne(group('Temperature')); if (temp) chosen.push(temp);

    list = [...others, ...chosen];
  }

  list.forEach(stim => {
    allStimuli.push({ cat, stim });
  });
});

const shuffledStimuli = jsPsych.randomization.shuffle(allStimuli);

// --- Build main trials and store separately before inserting attention checks ---
const mainTrials = [];
shuffledStimuli.forEach(({ cat, stim }) => {
  const key = `${cat}::${String(stim.label || '').replace(/\s+/g,' ').trim()}`;
  const child = childMap[key];
  const { name, img } = child;

  const needText = (stim.need || '').replace(/X/g, name).replace(/\n/g, '<br>');

  // Need page
  mainTrials.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `<div class="visual-wrapper">\n                 <p>${needText}</p>\n                 <div class="child-wrapper">\n                 <div class="emoji-bubble need-page ">${stim.emoji}</div>\n                 <img src="img/${img}.png" alt="${name}" class="child-image">\n                 <div>\n                 <img src="img/grid4.png" class="grid-image" alt="empty grid">\n               </div>`,
    choices: ['Continue'],
    data: { type: 'need_page', category: cat, stimulus_label: stim.label }
  });

  // Random amount 0-8
  const amount = Math.floor(Math.random() * 9);
  const need = needText;
  const isParty = (cat === 'social') && /^Inviting friends/.test(stim.label || '');
  const msg = buildMessage(name, stim, amount, isParty);
  const visual = `<p class="need-text">${need}</p>` + buildVisual(amount, stim.emoji, cat, img, name);

  mainTrials.push(
    sliderTrial({
      visual,
      need,
      msg,
      cat,
      label: stim.label,
      amt: amount,
      n: 1,
      poss: possessiveFor(name),
      childName: name
    })
  );
});

const attentionChecks = [
  attentionCheck('left'),
  attentionCheck('right')
];
const totalMain = mainTrials.length;
const attentionIndices = jsPsych.randomization.sampleWithoutReplacement([...Array(totalMain).keys()], 2).sort((a,b) => a-b);
attentionIndices.reverse().forEach((idx, i) => {
  mainTrials.splice(idx, 0, attentionChecks[i]);
});

mainTrials.forEach(t => timeline.push(t));
  
  // ===== Thank-you and data submission =====
  const thankYou = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `<div class="intro-screen"><h2>Thank you for participating!</h2></div>`,
    choices: ['Finish'],
  };
  timeline.push(debrief);
  timeline.push(feedback_demographics);
  timeline.push(save_data)
  timeline.push(thankYou);
  jsPsych.run(timeline);
  })
</script>
</body>
</html>
